# 漫画ページコンポーザー - 開発コンテキスト

## 最終更新: 2025-12-12

---

## 概要

**漫画ページコンポーザー**は、1コマ漫画生成アプリで生成した画像を組み合わせて漫画ページを作成するツールです。API呼び出しなしのローカル処理（Pillow）で動作します。

---

## 機能一覧

| 機能 | 説明 | 状態 |
|------|------|------|
| 4コマテンプレート | 16:9×4縦並び | ✅ |
| 8コマテンプレート | 4:3×4の2列 | ✅ |
| 画像配置 | 各コマに生成済み画像を選択 | ✅ |
| 自動調整 | アスペクト比維持で中央クロップ＆リサイズ | ✅ |
| 吹き出し追加 | 4スタイル（丸/角丸/ギザギザ/雲） | ✅ |
| 出力サイズ | 720px / 1080px / 1440px | ✅ |
| プレビュー | リアルタイムプレビュー | ✅ |

---

## ファイル構成

```
app/ui/manga_composer_window.py   # メインウィンドウ（CTkToplevel）
```

### 主要クラス・定数

```python
# テンプレート定義
TEMPLATES = {
    "4コマ（16:9縦並び）": {
        "cols": 1,
        "rows": 4,
        "panel_ratio": (16, 9)
    },
    "8コマ（4:3 2列）": {
        "cols": 2,
        "rows": 4,
        "panel_ratio": (4, 3)
    }
}

# 出力サイズ
OUTPUT_WIDTHS = {
    "標準（720px）": 720,
    "高解像度（1080px）": 1080,
    "大（1440px）": 1440
}

# 吹き出しスタイル
BUBBLE_STYLES = {
    "丸（通常）": "oval",
    "角丸四角": "rounded_rect",
    "ギザギザ（叫び）": "burst",
    "思考（雲）": "cloud"
}
```

---

## UI構成

```
┌────────────────────────────────────────────────────────────────┐
│  左パネル（設定）              │  右パネル（プレビュー）        │
├────────────────────────────────┼────────────────────────────────┤
│ ・テンプレート選択             │  ・プレビュー表示              │
│   - レイアウト                 │    （スクロール対応）          │
│   - 出力幅                     │                                │
│                                │                                │
│ ・コマ画像（スクロール）       │                                │
│   - コマ1: [パス] [参照] [×]  │                                │
│   - コマ2: [パス] [参照] [×]  │                                │
│   - ...                        │                                │
│                                │                                │
│ ・吹き出し追加                 │                                │
│   - 対象コマ選択               │                                │
│   - スタイル選択               │                                │
│   - セリフ入力                 │                                │
│   - [追加]                     │                                │
│   - 追加済みリスト             │                                │
│                                │                                │
│ [プレビュー更新] [画像を出力]  │                                │
└────────────────────────────────┴────────────────────────────────┘
```

---

## 主要メソッド

### MangaComposerWindow クラス

| メソッド | 説明 |
|----------|------|
| `__init__` | ウィンドウ初期化、UI構築 |
| `_build_left_panel` | 左パネル（設定エリア）構築 |
| `_build_right_panel` | 右パネル（プレビュー）構築 |
| `_create_panel_selectors` | コマ選択UI作成（テンプレート変更時に再構築） |
| `_on_template_change` | テンプレート変更ハンドラ |
| `_browse_panel_image` | 画像選択ダイアログ |
| `_add_bubble` | 吹き出し追加 |
| `_compose_image` | 画像合成（メイン処理） |
| `_fit_image_to_panel` | 画像をコマサイズにフィット |
| `_draw_bubble` | 吹き出し描画 |
| `_update_preview` | プレビュー更新 |
| `_export_image` | 画像出力 |

---

## 画像合成処理の流れ

1. **キャンバス作成**: 白背景、テンプレートに応じたサイズ
2. **各コマを配置**:
   - 画像あり → `_fit_image_to_panel`でフィット
   - 画像なし → グレー背景＋コマ番号表示
3. **吹き出し描画**: 各コマに設定された吹き出しを描画
4. **コマ枠描画**: 黒い枠線

### _fit_image_to_panel の処理

```
1. 画像とコマのアスペクト比を比較
2. 画像が横長 → 上下に合わせて左右を中央クロップ
3. 画像が縦長 → 左右に合わせて上下を中央クロップ
4. コマサイズにリサイズ（LANCZOS）
```

---

## main.py への統合

### インポート
```python
from ui.manga_composer_window import MangaComposerWindow
```

### ボタン追加（左列のボタンエリア）
```python
self.manga_composer_button = ctk.CTkButton(
    button_frame,
    text="漫画ページコンポーザー",
    height=35,
    fg_color="#6B4C9A",
    hover_color="#5A3D89",
    command=self._open_manga_composer
)
```

### コールバック
```python
def _open_manga_composer(self):
    """漫画ページコンポーザーを開く"""
    MangaComposerWindow(self)
```

---

## 技術的な注意点

### 1. フォント

```python
# macOS
font = ImageFont.truetype("/System/Library/Fonts/ヒラギノ角ゴシック W3.ttc", 16)
# Linux フォールバック
font = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 16)
# 最終フォールバック
font = ImageFont.load_default()
```

### 2. 吹き出し位置

- 相対位置で管理: `(0.5, 0.2)` = コマ中央、上から20%
- コマ内に収まるよう自動調整

### 3. テンプレート切り替え時

- コマ選択UIを再構築（`_create_panel_selectors`）
- 画像・吹き出しデータをクリア
- プレビューをリセット

---

## 今後の拡張案

| 機能 | 説明 | 優先度 |
|------|------|--------|
| カスタムテンプレート | コマ数・比率を自由に設定 | 中 |
| 吹き出し位置調整 | ドラッグで位置変更 | 中 |
| 吹き出し削除 | 追加済み吹き出しの削除 | 高 |
| 縦書きテキスト | 日本語縦書き対応 | 低 |
| コマ枠スタイル | 枠線の太さ・色変更 | 低 |
| ページ背景 | 白以外の背景色 | 低 |

---

## 関連ファイル

- `app/main.py` - メインアプリ（ボタン追加）
- `app/ui/four_panel_window.py` - 4コマ漫画設定（YAML生成用）
- `README.md` - ユーザードキュメント
- `CLAUDE_CONTEXT_1コマアプリ設計.md` - 全体設計コンテキスト

---

## クイックスタート

```bash
# アプリ起動
cd /workspace
./run_app.command

# 「漫画ページコンポーザー」ボタン（紫）をクリック
```

---

## 引き継ぎ時の確認ポイント

1. このファイルを読む
2. `app/ui/manga_composer_window.py` の実装を確認
3. テンプレート追加時は `TEMPLATES` 辞書に追加
4. 吹き出しスタイル追加時は `BUBBLE_STYLES` と `_draw_bubble` を更新
