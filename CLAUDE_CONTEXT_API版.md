# 4コマ漫画プロンプト作成ツール (API対応版) - 開発コンテキスト

## プロジェクト概要
Manga-Generatorの上位互換として、YAMLプロンプト生成に加えてGoogle GenAI APIを直接叩いて4コマ漫画を高品質に生成するデスクトップアプリ。

## 現在の状態: v1.1（API対応版・安定版）

### 実装済み機能

#### 基本機能（Manga-Generator互換）
- タイトル・作者名入力
- キャラクター名・説明入力（1〜2人対応）
- 服装ビルダー機能（カテゴリ/形状/色/柄/スタイル）
  - 男女両方に対応した豊富なプリセット
- 1〜4コマのプロンプト入力
- セリフ入力（話者選択、左右位置、同時セリフ対応）
- ナレーション入力
- カラーモード選択（フルカラー/モノクロ）
- YAML生成・プレビュー・コピー・保存
- YAML読み込み・履歴機能

#### API対応機能
- **出力モード選択**: YAML出力 / 画像出力(API使用)
- **APIサブモード**:
  - **漫画生成**: YAMLプロンプト + キャラ参照画像 → 4コマ漫画生成
  - **参考漫画清書**: YAML + 参考漫画画像 + キャラ参照画像 → 高品質清書
- **キャラクター参照画像パス入力**（1〜2キャラ分）
- **参考漫画画像パス入力**（清書モード用）
- **解像度選択**: 1K / 2K / 4K
- **漫画プレビュー表示**（自動リサイズ）
- **生成画像保存機能**
- **スレッド処理**によるUI非同期化（フリーズ防止）
- **Generateボタンのラベル動的変更**（モードに応じて変化）

### 服装ビルダー（男女対応）

| カテゴリ | 主な形状オプション |
|---------|-------------------|
| スーツ | パンツスタイル、スリーピース、ダブルスーツ、タキシード |
| 水着 | ビキニ各種、ワンピース、サーフパンツ、競泳パンツ |
| カジュアル | Tシャツ+デニム、パーカー、シャツ+チノパン、レザージャケット |
| 制服 | セーラー服、ブレザー、学ラン、詰襟、警察官、軍服 |
| ドレス/フォーマル | イブニングドレス、タキシード、モーニング、燕尾服 |
| スポーツ | テニスウェア、サッカー/野球/バスケユニフォーム、柔道着 |
| 和服 | 着物、浴衣、振袖、袴、紋付袴、甚平 |
| 作業着/職業服 | 白衣、作業着、シェフコート、消防服、建設作業員 |

### UIレイアウト
3列構成、ウィンドウサイズ1800x1000px

```
┌────────────────┬──────────────────────────┬────────────────┐
│  左列          │     中央列               │  右列          │
│ ・出力モード   │  ・1〜4コマ目            │ ・YAMLプレビュー│
│   選択         │   (プロンプト/セリフ)    │   (200px)      │
│ ・APIサブモード│                          │                │
│ ・API Key      │  [Generate] [クリア]     │ ・漫画プレビュー│
│ ・タイトル     │                          │   (残りスペース)│
│ ・作者名       │                          │                │
│ ・カラーモード │                          │ [読込][履歴]   │
│ ・画質(1K/2K/4K)│                         │ [コピー][保存] │
│ ・登場人物     │                          │ [画像保存]     │
│  - 画像パス    │                          │                │
│  - 服装設定    │                          │                │
│ ・参考漫画画像 │                          │                │
└────────────────┴──────────────────────────┴────────────────┘
```

### ファイル構成
```
/workspace/
├── app/
│   ├── main.py            # メインアプリケーション
│   ├── requirements.txt   # 依存ライブラリ
│   └── recent_files.json  # 履歴ファイル
├── template.yaml          # テンプレートファイル
├── run_app.command        # macOS/Linux起動スクリプト
├── run_app_windows.bat    # Windows起動スクリプト
├── README.md              # ユーザー向けドキュメント
├── CLAUDE_CONTEXT.md      # 基本版の開発コンテキスト
├── CLAUDE_CONTEXT_API版.md # API版の開発コンテキスト（このファイル）
└── ref/                   # 参照プロジェクト
    ├── nanobanana/        # NanoBanana Pro（API参照）
    └── manga-generator/   # Manga-Generator（UI参照）
```

### 技術スタック

| 項目 | 内容 |
|------|------|
| 言語 | Python 3.10+ |
| GUI | CustomTkinter |
| API | google-genai (`gemini-3-pro-image-preview`) |
| 画像処理 | Pillow |
| YAML処理 | PyYAML |
| クリップボード | pyperclip |
| 実行環境 | venv仮想環境 |

### API呼び出しフロー

#### 漫画生成モード
1. ユーザーがフォームに入力 → 「Generate (漫画生成)」ボタン押下
2. `generate_yaml()` でYAMLプロンプトを生成・プレビュー表示
3. `start_api_generation()` でスレッド起動
4. `generate_manga_api()` でAPI呼び出し:
   - シンプルな指示 + YAMLプロンプト + キャラ参照画像を送信
   - `gemini-3-pro-image-preview` モデルを使用
5. `process_api_response()` でレスポンスから画像抽出
6. `update_manga_preview()` でプレビュー表示

#### 参考漫画清書モード
1. ユーザーがフォームに入力（プロンプト・セリフ必須）
2. 参考漫画画像パス + キャラ参照画像パスを指定
3. 「Generate (清書)」ボタン押下
4. YAML生成後、`start_redraw_generation()` でスレッド起動
5. `redraw_manga_api()` でAPI呼び出し:
   - シンプルな指示 + YAML + 参考漫画画像 + キャラ参照画像を送信
   - セリフ・タイトルはYAMLから正確に再現
   - 構図・ポーズは参考漫画画像を参考に
   - キャラクターの顔はキャラ参照画像を使用
6. 以降は漫画生成モードと同様

### 重要な実装ポイント

1. **モデル選択**
   - `gemini-3-pro-image-preview` を使用（ブラウザ版Geminiと同等品質）
   - `gemini-2.0-flash-exp-image-generation` は品質が低いため不採用

2. **プロンプトはシンプルに**
   - 複雑な指示はGeminiが混乱する原因
   - 「以下のyamlの内容を忠実に再現してください」程度でOK

3. **清書モードではYAML必須**
   - 画像だけではセリフが正確に再現されない
   - YAML + 参考漫画画像 + キャラ画像の3点セットで送信

4. **スレッド処理**
   - API呼び出しは `threading.Thread` で非同期実行
   - UIの応答性を維持（フリーズ防止）
   - `self.after(0, callback)` でメインスレッドにUIの更新を委譲

5. **モード連動UI**
   - YAML出力モード時: API関連入力欄を無効化
   - 画像出力モード時: API Key、画質、画像パス入力を有効化
   - Generateボタンのラベルがモードに応じて変化

## 起動方法
```bash
./run_app.command  # macOS/Linux
run_app_windows.bat  # Windows
```

## 開発時の注意点

1. **API Keyの扱い**
   - 入力欄は `show="*"` でマスク表示
   - コードにハードコードしない

2. **venv互換性**
   - `.venv`はOS間で互換性がないため、環境移動時は削除して再作成
   - 起動スクリプトが自動で.venvを作成・依存関係をインストール

3. **画像処理**
   - CTkImageを使用（garbage collection対策でインスタンス保持）
   - プレビューは自動リサイズ（アスペクト比維持）

4. **エラーハンドリング**
   - API エラー時はメッセージボックスで通知
   - 参照画像が見つからない場合は事前チェック

## 今後の拡張予定
- キャラクタープリセット保存機能
- テンプレート選択機能
- バッチ生成機能
- 生成履歴管理
