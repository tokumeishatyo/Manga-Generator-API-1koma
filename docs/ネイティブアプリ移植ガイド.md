# AI創作工房 ネイティブアプリ移植ガイド

**バージョン:** 1.0
**最終更新:** 2025-12-17
**対象プラットフォーム:** Windows / macOS

---

## 目次

0. [参照ファイル一覧](#0-参照ファイル一覧)
1. [移植の方針](#1-移植の方針)
2. [現在のアーキテクチャ](#2-現在のアーキテクチャ)
3. [推奨技術スタック](#3-推奨技術スタック)
4. [APIキーの扱い（重要）](#4-apiキーの扱い重要)
5. [レイヤー別移植ガイド](#5-レイヤー別移植ガイド)
6. [定数・データ定義の移植](#6-定数データ定義の移植)
7. [API呼び出しの実装](#7-api呼び出しの実装)
8. [画像処理の実装](#8-画像処理の実装)
9. [テスト項目](#9-テスト項目)
10. [配布時の注意事項](#10-配布時の注意事項)

---

## 0. 参照ファイル一覧

移植作業時は、以下のフォルダ・ファイルを参照してください。

### 参照すべきフォルダ

```
/docs/    ← ドキュメント（本ファイル含む）
/app/     ← ソースコード
```

### docs/ フォルダ（ドキュメント）

| ファイル | 内容 | 用途 |
|----------|------|------|
| `機能仕様書.md` | 全機能の詳細仕様 | 機能要件の確認 |
| `操作マニュアル.md` | ユーザー向け操作説明 | UI/UX設計の参考 |
| `ネイティブアプリ移植ガイド.md` | 本ファイル | 移植手順の確認 |

### app/ フォルダ（ソースコード）

#### 必須ファイル（ロジック・定数）

| ファイル | 行数 | 内容 | 移植優先度 |
|----------|------|------|-----------|
| `constants.py` | 約650行 | 全定数・プリセット定義 | **最優先** |
| `logic/yaml_generator.py` | - | YAMLプロンプト生成 | **最優先** |
| `logic/api_client.py` | - | Gemini API呼び出し | **最優先** |
| `logic/file_manager.py` | - | ファイル操作 | 必須 |
| `logic/reference_collector.py` | - | 参照画像収集 | 必須 |
| `logic/scene_builder.py` | - | シーン合成ロジック | 必須 |
| `logic/usage_tracker.py` | - | 使用量トラッキング | オプション |
| `logic/character.py` | - | キャラクター関連 | 必須 |

#### UI参照ファイル（レイアウト・動作の参考）

| ファイル | 対応機能 | UI複雑度 |
|----------|----------|----------|
| `main.py` | メインウィンドウ（3カラム構成） | 高 |
| `ui/base_settings_window.py` | 設定ウィンドウ基底クラス | 中 |
| `ui/character_sheet_window.py` | 顔三面図設定 | 中 |
| `ui/body_sheet_window.py` | 素体三面図設定 | 中 |
| `ui/outfit_window.py` | 衣装設定（連動プルダウン） | 高 |
| `ui/pose_window.py` | ポーズ設定 | 高 |
| `ui/background_window.py` | 背景生成設定 | 中 |
| `ui/scene_builder_window.py` | シーン構築（タブ切替） | 高 |
| `ui/style_transform_window.py` | スタイル変換設定 | 中 |
| `ui/decorative_text_window.py` | 装飾テキスト設定 | 高 |
| `ui/four_panel_window.py` | 4コマ漫画設定 | 高 |
| `ui/infographic_window.py` | インフォグラフィック設定 | 高 |
| `ui/manga_composer_window.py` | 漫画コンポーザー | 高 |
| `ui/bg_remover_window.py` | 背景透過ツール | 低 |
| `ui/text_overlay_placement_window.py` | テキスト配置 | 中 |

#### 不要ファイル（移植時は無視）

```
__pycache__/          ← Pythonキャッシュ
*.pyc                 ← コンパイル済みファイル
main_backup.py        ← バックアップ
recent_files.json     ← 実行時生成ファイル
requirements.txt      ← Python依存関係（参考程度）
```

### UI実装の参考ポイント

各UIファイルで特に参照すべき箇所：

| ファイル | 参照すべきメソッド | 内容 |
|----------|-------------------|------|
| 全ui/*.py | `build_content()` | UIレイアウト構築 |
| 全ui/*.py | `collect_data()` | 入力データ収集 |
| 全ui/*.py | `validate()` | 入力検証 |
| `main.py` | `_build_left_column()` | 左カラム（設定） |
| `main.py` | `_build_center_column()` | 中央カラム（YAML） |
| `main.py` | `_build_right_column()` | 右カラム（プレビュー） |
| `outfit_window.py` | `_on_category_change()` | 連動プルダウン実装 |

---

## 1. 移植の方針

### 1.1 基本方針

| 項目 | 方針 |
|------|------|
| **機能範囲** | Python版と同等の機能を実装 |
| **APIキー** | ユーザーが自分のキーを入力、終了時に消去 |
| **データ保存** | YAMLファイルのみ（APIキーは保存しない） |
| **オフライン機能** | YAML出力モードはオフラインで動作 |

### 1.2 移植対象機能

| カテゴリ | 機能 | 優先度 |
|----------|------|--------|
| **コア** | YAML生成（全タイプ） | 必須 |
| **コア** | API呼び出し・画像生成 | 必須 |
| **コア** | 画像プレビュー・保存 | 必須 |
| **UI** | 各種設定ウィンドウ | 必須 |
| **加工** | 背景透過 | 推奨 |
| **加工** | 漫画コンポーザー | 推奨 |
| **統計** | 使用量トラッキング | オプション |

### 1.3 移植しない機能（必要に応じて再検討）

- 使用統計のJSON保存（セッション中のみのカウントで代替可）

---

## 2. 現在のアーキテクチャ

### 2.1 ディレクトリ構造

```
app/
├── main.py              # エントリーポイント、メインUI
├── constants.py         # 全定数定義（約650行）
├── logic/
│   ├── api_client.py    # Gemini API呼び出し
│   ├── yaml_generator.py # YAMLプロンプト生成
│   ├── file_manager.py  # ファイル操作
│   ├── usage_tracker.py # 使用量トラッキング
│   ├── reference_collector.py # 参照画像収集
│   ├── scene_builder.py # シーン合成ロジック
│   └── character.py     # キャラクター関連
└── ui/
    ├── base_settings_window.py  # 設定ウィンドウ基底クラス
    ├── character_sheet_window.py
    ├── pose_window.py
    ├── outfit_window.py
    ├── body_sheet_window.py
    ├── background_window.py
    ├── scene_builder_window.py
    ├── style_transform_window.py
    ├── decorative_text_window.py
    ├── four_panel_window.py
    ├── infographic_window.py
    ├── manga_composer_window.py
    ├── bg_remover_window.py
    └── text_overlay_placement_window.py
```

### 2.2 レイヤー構成

```
┌─────────────────────────────────────────┐
│              UI層 (main.py + ui/*.py)   │
│         CustomTkinter / Tkinter          │
├─────────────────────────────────────────┤
│            ロジック層 (logic/*.py)       │
│    YAML生成 / API呼び出し / ファイル管理  │
├─────────────────────────────────────────┤
│            定数層 (constants.py)         │
│      プリセット / 選択肢 / プロンプト     │
├─────────────────────────────────────────┤
│              外部API                     │
│         Google Gemini API                │
└─────────────────────────────────────────┘
```

### 2.3 データフロー

```
ユーザー入力
    ↓
設定ウィンドウ (ui/*.py)
    ↓
データ収集 (collect_data メソッド)
    ↓
YAML生成 (logic/yaml_generator.py)
    ↓
[YAML出力モード] → クリップボードにコピー → 終了
    ↓
[通常/清書/シンプルモード]
    ↓
API呼び出し (logic/api_client.py)
    ↓
画像受信・表示
    ↓
保存 (logic/file_manager.py)
```

---

## 3. 推奨技術スタック

### 3.1 クロスプラットフォーム（推奨）

| 技術 | メリット | デメリット |
|------|----------|------------|
| **Electron + React/Vue** | 1コードでWin/Mac対応、Web技術で開発可能 | アプリサイズ大（100MB〜） |
| **Tauri + React/Vue** | 軽量（10MB〜）、Rust製で高速 | Rust学習コスト |
| **Flutter Desktop** | 1コードでWin/Mac/Linux対応、美しいUI | Dart学習コスト |

### 3.2 プラットフォーム別

**Windows専用:**
| 技術 | メリット | デメリット |
|------|----------|------------|
| **.NET (WPF/WinUI)** | Microsoft公式、高機能UI | Windows専用 |
| **C++ (Qt)** | 高速、クロスプラットフォーム可能 | 開発コスト高 |

**macOS専用:**
| 技術 | メリット | デメリット |
|------|----------|------------|
| **SwiftUI** | Apple公式、モダンなUI | macOS専用 |
| **AppKit** | 成熟した技術 | 学習コスト |

### 3.3 推奨構成

**最小工数でクロスプラットフォーム対応する場合:**

```
Tauri + Vue 3 + TypeScript
```

理由:
- アプリサイズが小さい（10〜30MB）
- Web技術（HTML/CSS/JS）で開発可能
- Rustの高速なバックエンドが使える
- Windows/macOS両対応

---

## 4. APIキーの扱い（重要）

### 4.1 基本原則

```
【絶対に守ること】
1. APIキーをディスクに保存しない
2. APIキーを設定ファイルに書き出さない
3. APIキーをログに出力しない
4. アプリ終了時にメモリから消去する
```

### 4.2 実装パターン

```
起動時:
┌─────────────────────────────┐
│   APIキー入力ダイアログ      │
│   [________________]        │
│   ※入力欄はマスク表示       │
│        [設定] [キャンセル]   │
└─────────────────────────────┘
           ↓
    メモリ上の変数に保持
    （グローバル変数は避ける）
           ↓
動作中:
    必要な時だけ変数を参照
           ↓
終了時:
    変数をnull/空文字で上書き
    ガベージコレクション実行（言語による）
```

### 4.3 各言語での実装例

**TypeScript (Electron/Tauri):**
```typescript
class ApiKeyManager {
  private apiKey: string | null = null;

  setApiKey(key: string): void {
    this.apiKey = key;
  }

  getApiKey(): string | null {
    return this.apiKey;
  }

  clearApiKey(): void {
    this.apiKey = null;
  }
}
// アプリ終了時に clearApiKey() を呼び出す
```

**C# (.NET):**
```csharp
public sealed class ApiKeyManager : IDisposable
{
    private SecureString? _apiKey;

    public void SetApiKey(string key)
    {
        _apiKey = new SecureString();
        foreach (char c in key) _apiKey.AppendChar(c);
        _apiKey.MakeReadOnly();
    }

    public void Dispose()
    {
        _apiKey?.Dispose();
        _apiKey = null;
    }
}
```

**Swift:**
```swift
class ApiKeyManager {
    private var apiKey: String?

    func setApiKey(_ key: String) {
        apiKey = key
    }

    func clearApiKey() {
        apiKey = nil
    }
}
```

### 4.4 UI上の配慮

- 入力欄は`password`タイプ（マスク表示）
- コピー&ペーストは許可（ユーザビリティのため）
- 「キーを表示」トグルボタンは任意

---

## 5. レイヤー別移植ガイド

### 5.1 定数層（constants.py）

**移植方法:** JSONまたは言語固有の定数ファイルに変換

Python版の定数（約650行）を移植する。主な定数：

| 定数名 | 内容 | 行数目安 |
|--------|------|----------|
| `OUTPUT_TYPES` | 出力タイプ定義 | 20行 |
| `CHARACTER_STYLES` | キャラクタースタイル | 20行 |
| `BODY_TYPE_PRESETS` | 体型プリセット | 50行 |
| `OUTFIT_DATA` | 服装データ（階層構造） | 150行 |
| `CHARACTER_POSES` | ポーズプリセット | 30行 |
| `EFFECT_TYPES/COLORS` | エフェクト定義 | 40行 |
| `INFOGRAPHIC_STYLES` | インフォグラフィック | 30行 |
| `COLOR_MODES` | カラーモード | 10行 |

**TypeScript例:**
```typescript
// constants.ts
export const OUTPUT_TYPES = {
  "顔三面図": "step1_face",
  "素体三面図": "step2_body",
  // ...
} as const;

export const OUTFIT_DATA = {
  カテゴリ: {
    "おまかせ": "",
    "スーツ": "business suit",
    // ...
  },
  形状: {
    スーツ: {
      "おまかせ": "",
      "パンツスタイル": "pant suit, trousers",
      // ...
    },
    // ...
  },
  // ...
};
```

### 5.2 ロジック層（logic/*.py）

**移植対象ファイル:**

| ファイル | 役割 | 移植難易度 |
|----------|------|-----------|
| `yaml_generator.py` | YAMLプロンプト生成 | 低（文字列操作のみ） |
| `api_client.py` | Gemini API呼び出し | 中（HTTP/SDK） |
| `file_manager.py` | ファイル操作 | 低 |
| `reference_collector.py` | 参照画像収集 | 低 |
| `scene_builder.py` | シーン合成ロジック | 低 |
| `usage_tracker.py` | 使用量トラッキング | 低（オプション） |

### 5.3 UI層（main.py + ui/*.py）

**移植方針:**

1. **メインウィンドウ（main.py）**
   - 3カラムレイアウトを再現
   - 左: 設定パネル、中央: YAMLプレビュー、右: 画像プレビュー

2. **設定ウィンドウ（ui/*.py）**
   - 各ウィンドウは独立したコンポーネント/ダイアログとして実装
   - `BaseSettingsWindow`の継承パターンを参考に基底クラスを作成

**UIコンポーネント対応表:**

| Python (CustomTkinter) | Web (HTML/React) | .NET (WPF) | Swift (SwiftUI) |
|------------------------|------------------|------------|-----------------|
| CTkEntry | `<input>` | TextBox | TextField |
| CTkTextbox | `<textarea>` | TextBox (multiline) | TextEditor |
| CTkButton | `<button>` | Button | Button |
| CTkOptionMenu | `<select>` | ComboBox | Picker |
| CTkCheckBox | `<input type="checkbox">` | CheckBox | Toggle |
| CTkSlider | `<input type="range">` | Slider | Slider |
| CTkFrame | `<div>` | Grid/StackPanel | VStack/HStack |
| CTkTabview | Tabs component | TabControl | TabView |

---

## 6. 定数・データ定義の移植

### 6.1 服装データ（OUTFIT_DATA）の構造

```
OUTFIT_DATA
├── カテゴリ: { 日本語名: 英語プロンプト }
├── 形状: { カテゴリ名: { 形状名: 英語プロンプト } }
├── 色: { 日本語名: 英語 }
├── 柄: { 日本語名: 英語 }
└── スタイル: { 日本語名: 英語 }
```

カテゴリに応じて形状の選択肢が変わる**連動プルダウン**を実装する。

### 6.2 年齢表現の安全変換（AGE_EXPRESSION_CONVERSIONS）

Gemini APIのSafety Filter対策として、年齢表現を体型表現に変換する辞書。

```
入力: "中学生の女の子"
変換後: "youthful petite appearance, teenage-looking, young face"
```

YAML生成時にこの変換を適用すること。

### 6.3 プロンプトテンプレート

`yaml_generator.py`内のYAMLテンプレートをそのまま移植する。

主要テンプレート:
- 顔三面図 (`generate_face_sheet_yaml`)
- 素体三面図 (`generate_body_sheet_yaml`)
- 衣装三面図 (`generate_outfit_yaml`)
- ポーズ三面図 (`generate_pose_yaml`)
- 背景 (`generate_background_yaml`)
- シーン合成 (`generate_scene_yaml`)
- インフォグラフィック (`generate_infographic_yaml`)

---

## 7. API呼び出しの実装

### 7.1 Gemini API仕様

**エンドポイント:**
- モデル: `gemini-2.0-flash-preview-image-generation`（または最新の画像生成対応モデル）
- SDK: Google AI SDK（各言語版）

**リクエスト構造:**
```
{
  contents: [
    { parts: [
      { text: "プロンプト文字列" },
      { inline_data: { mime_type: "image/png", data: "base64..." } }  // 参照画像
    ]}
  ],
  generation_config: {
    response_modalities: ["image", "text"]
  }
}
```

### 7.2 各言語でのSDK

| 言語 | SDK | インストール |
|------|-----|-------------|
| JavaScript/TypeScript | `@google/generative-ai` | `npm install @google/generative-ai` |
| C# | `Google.Cloud.AIPlatform.V1` | NuGet |
| Swift | REST API直接呼び出し | - |
| Rust | `google-generative-ai-rs` | Cargo |

### 7.3 TypeScript実装例

```typescript
import { GoogleGenerativeAI } from "@google/generative-ai";

async function generateImage(
  apiKey: string,
  prompt: string,
  referenceImages: { mimeType: string; data: string }[]
): Promise<{ success: boolean; imageData?: string; error?: string }> {
  try {
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({
      model: "gemini-2.0-flash-preview-image-generation",
    });

    const parts = [{ text: prompt }];
    for (const img of referenceImages) {
      parts.push({
        inlineData: { mimeType: img.mimeType, data: img.data }
      });
    }

    const result = await model.generateContent({
      contents: [{ role: "user", parts }],
      generationConfig: { responseModalities: ["image", "text"] }
    });

    // 画像データの抽出
    const response = result.response;
    for (const part of response.candidates[0].content.parts) {
      if (part.inlineData) {
        return { success: true, imageData: part.inlineData.data };
      }
    }
    return { success: false, error: "No image in response" };
  } catch (e) {
    return { success: false, error: e.message };
  }
}
```

### 7.4 エラーハンドリング

| エラー種別 | 対応 |
|------------|------|
| APIキー無効 | エラーメッセージ表示、再入力促進 |
| Safety Filter | 「生成できませんでした」と表示 |
| レート制限 | リトライ or 待機メッセージ |
| ネットワークエラー | タイムアウト後にエラー表示 |

---

## 8. 画像処理の実装

### 8.1 必要な画像処理機能

| 機能 | Python実装 | 移植先での実装 |
|------|-----------|----------------|
| 画像読み込み | PIL.Image.open | 各プラットフォームの標準ライブラリ |
| Base64エンコード | base64.b64encode | 標準ライブラリ |
| リサイズ | PIL.Image.resize | Canvas API / System.Drawing / CoreImage |
| 背景透過 | PIL手動実装 | 同様のアルゴリズムを移植 |
| 画像保存 | PIL.Image.save | 標準ライブラリ |

### 8.2 背景透過アルゴリズム

Python版（`bg_remover_window.py`）の実装:

```
1. 四隅のピクセル色を取得
2. 最も多い色を背景色と判定
3. フラッドフィル方式で背景領域を特定
4. 背景領域のアルファを0に設定
5. PNG形式で保存
```

---

## 9. テスト項目

### 9.1 機能テスト

| カテゴリ | テスト項目 |
|----------|-----------|
| **APIキー** | 入力→動作→終了→再起動で消えていることを確認 |
| **YAML生成** | 各出力タイプで正しいYAMLが生成されること |
| **API呼び出し** | 画像が正常に生成・表示されること |
| **画像保存** | PNG形式で正しく保存されること |
| **エラー処理** | 無効なAPIキー、ネットワークエラー時の挙動 |

### 9.2 セキュリティテスト

| テスト項目 | 確認内容 |
|-----------|----------|
| APIキー非保存 | 設定ファイル、ログ、一時ファイルにAPIキーがないこと |
| メモリ消去 | 終了後にメモリダンプでAPIキーが見つからないこと |
| 通信暗号化 | HTTPS通信のみ使用していること |

### 9.3 互換性テスト

| プラットフォーム | テスト環境 |
|------------------|-----------|
| Windows | Windows 10, Windows 11 |
| macOS | macOS 12 (Monterey) 以降 |

---

## 10. 配布時の注意事項

### 10.1 ライセンス表記

使用ライブラリのライセンスを確認し、必要に応じて表記する。

### 10.2 免責事項

以下をアプリ内またはドキュメントに記載:

```
- 本アプリはGoogle Gemini APIを使用します
- APIの利用にはユーザー自身のAPIキーが必要です
- API利用料金はユーザー負担となります
- 生成された画像の著作権・利用権はユーザーの責任で管理してください
- APIのSafety Filterにより、一部のコンテンツは生成が拒否される場合があります
```

### 10.3 配布形式

| プラットフォーム | 推奨形式 |
|------------------|----------|
| Windows | MSIインストーラー or ポータブルZIP |
| macOS | DMG（署名付き）or App Store |

### 10.4 コード署名

- **Windows**: コード署名証明書を取得してEXEに署名（SmartScreen警告回避）
- **macOS**: Apple Developer Programに登録して署名・公証

---

## 付録A: 参照すべきPythonコード

### YAML生成の核心部分

`logic/yaml_generator.py` の各`generate_*_yaml`関数を参照。
テンプレートリテラルとして移植可能。

### API呼び出しの核心部分

`logic/api_client.py` の `generate_image_with_api` 関数を参照。

### 定数の全量

`constants.py` をJSON/YAML/TypeScript定数ファイルにエクスポートして使用。

---

## 付録B: 移植チェックリスト

```
[ ] 定数ファイルの変換完了
[ ] YAML生成ロジックの移植完了
[ ] API呼び出しの実装完了
[ ] メインUIの実装完了
[ ] 各設定ウィンドウの実装完了
    [ ] 顔三面図
    [ ] 素体三面図
    [ ] 衣装三面図
    [ ] ポーズ三面図
    [ ] 背景生成
    [ ] シーン構築
    [ ] インフォグラフィック
    [ ] 装飾テキスト
    [ ] 4コマ漫画
    [ ] スタイル変換
[ ] 画像プレビュー・保存の実装完了
[ ] 背景透過機能の実装完了（オプション）
[ ] 漫画コンポーザーの実装完了（オプション）
[ ] APIキーのセキュリティテスト完了
[ ] 全機能テスト完了
[ ] Windows動作確認完了
[ ] macOS動作確認完了
```

---

**ドキュメント終了**
